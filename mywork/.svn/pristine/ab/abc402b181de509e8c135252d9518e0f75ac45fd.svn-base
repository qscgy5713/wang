<?php
/**
 * 管理Action
 */
class AdminAction extends ApiAction {
    /**
     * 初始化
     */
    protected function _initialize() {
        // 執行父類初始化
        parent::_initialize();
        
        
        $request = $this->getRequest();
        //var_dump($request);
        /*
        $hash = MD5("ValidateKey="."S39W6V5BP7KYYSPLPW94A9ER".
            "&HashKey="."B3B46CHL4L4P3TL3BF9SREGRQ".
            "&RtnCode=".$request['RtnCode'].
            "&TradeID=".$request["MerTradeID"].
            "&UserID=".$request["MerUserID"].
            "&Money=".$request["Amount"]);

        echo "Validate=".$hash;//exit();*/
        //判斷代理是否已登入
        if(!($this->isAdminLogin())){
            //否，無登入狀態
            $this->assign("isLogin","false");
            if($request['_URL_'][0] != 'AdminIndex'){
                redirect(__APP__.'/AdminIndex/index');
            }
            return;
        }
        
        //判定有 登入後 所做的事
        $this->getAdminData();
        
        //是，登入狀態，判斷 公司帳號 是否停權
        if($this->isAdminLosePower()){
            //是  倒回首頁 顯示停權 視窗
            $status = $_SESSION['Admin']['status'];
            unset($_SESSION['Admin']);
            //$this->assign("waitSecond","15");
            $this->assign("jumpUrl","__APP__/AdminIndex/index");
            switch($status){
                case 1://一般停權
                    $this->error(L(strtoupper('ERROR_' . __CLASS__ . '_' . __FUNCTION__ . '_01')));
                    break;
            }
            return;
        }
        
        //判斷 代理 是否被踢登出 或 重複登入
        if($this->isAdminOutLogin()){
            //是  倒回首頁 顯示停權 視窗
            unset($_SESSION['Admin']);
            //$this->assign("waitSecond","15");
            $this->assign("jumpUrl","__APP__/AdminIndex/index");
            $this->error(L(strtoupper('ERROR_' . __CLASS__ . '_' . __FUNCTION__ . '_03')));
            return;
        }
        $showPageArray = $this->getPageArray();
        
        /*頁面權限管理
        $actionNamePower = cookie('adminActionPower');
        $actionNamePowerArray = explode(",", $actionNamePower);
        if(!in_array($request['_URL_'][0],$actionNamePowerArray) && $request['_URL_'][0] != 'AdminIndex' && $request['_URL_'][0] != 'Admin'){
            redirect(__APP__.'/AdminIndex/index');
        }*/
        
        $this->assign("isLogin","true");
        $this->assign("adminAccount",$_SESSION['Admin']['account']);
        $this->assign("showPageArray",$showPageArray);
    }
    protected function getRandStr($len)//驗證碼使用
    {
        $chars = array(
            "0", "1", "2","3", "4", "5", "6", "7", "8", "9"
        );
        $charsLen = count($chars) - 1;
        shuffle($chars);
        $output = "";
        for ($i=0; $i<$len; $i++)
        {
            $output .= $chars[mt_rand(0, $charsLen)];
        }
        return $output;
    } 
    
    /*
     * 讀取用戶資料
     * 重新取得 代理 資訊
     */
    protected function getAdminData(){
        
        if(strtolower($_SESSION['Admin']['account']) != "game"){
            $InternalAdmin = D("InternalAdmin");
            $data = array(
                "admin_id" => $_SESSION['Admin']['id']
            );
            $return = $InternalAdmin->getAdminDataPageDataById($data);
            if($return === false){
                $this->error(L(strtoupper('ERROR_' . __CLASS__ . '_' . __FUNCTION__ . '_01')));
            }
            $_SESSION['Admin']['uid'] = $return['admin_uid'];
            $_SESSION['Admin']['status'] = $return['admin_status'];
            $_SESSION['Admin']['pageData'] = substr($return['power_main'],0,-1);
        } else {
            $InternalAdmin = D("InternalAdmin");
            $data = array(
                "admin_account" => $_SESSION['Admin']['account'] //登入的帳號
            );
            $return = $InternalAdmin->getAdminDataByAccount($data);
            if($return === false){
                $this->error(L(strtoupper('ERROR_' . __CLASS__ . '_' . __FUNCTION__ . '_01')));
            }
            $_SESSION['Admin']['uid'] = $return['admin_uid'];
            $_SESSION['Admin']['status'] = $return['admin_status'];
        }
        
        
        
        
    }
    /*
     * 判斷 代理 是否登入
     */
    protected function isAdminLogin() {
        //判斷 SESSION 是否存在
        if(!isset($_SESSION['Admin']['account']) && !isset($_SESSION['Admin']['id'])){
            //否，回傳 false
            return false;
        }
        //是，回傳 true
        return true;
    }
    /*
     *  判斷 代理 是否被踢除或異地登入
     */
    protected function isAdminOutLogin() {
        //判斷 uid 是否與SESSION 的 login_uid 一致
        if($_SESSION['Admin']['uid'] === $_SESSION['Admin']['login_uid']){
            //是，回傳 false
            return false;
        }
        //否，回傳 true
        return true;
    }
    /*
     *  判斷 代理 是否停權
     */
    protected function isAdminLosePower() {
        //判斷 common_member member_status 是否是停權狀態
        if($_SESSION['Admin']['status'] == 1){
            //是，回傳 true
            return true;
        }
        //否，回傳 false
        return false;
    }
    /*
     *  取得頁面資訊
     */
    protected function getPageArray(){
        $CommonAdminPageclass = D("CommonAdminPageclass");//讀取頁面Class
        $return = $CommonAdminPageclass->getAdminPageClassDataUse();
        if($return === false){
            $this->error(L(strtoupper('ERROR_' . __CLASS__ . '_' . __FUNCTION__ . '_01')));
        }
        $classArray = array();
        //使用欄位轉換  資料庫欄位 => 輸出名稱
        $FieldChange = array(
            "pageclass_id"=>"id",
            "pageclass_showName"=>"showName"
        );
        $showStr = "";
        foreach ($return as $key => $value){
            foreach ($FieldChange as $key1 => $value1){
                //欄位特別處理
                switch ($key1){
                    default://未做設定 正常顯示
                        $showStr = $value[$key1];
                        break;
                }
                $classArray[$key][$value1] = $showStr;
            }
        }
        
        $CommonAdminPageclassPage = D("CommonAdminPageclassPage");
        $return = $CommonAdminPageclassPage->getAdminPageDataUse();
        if($return === false){
            $this->error(L(strtoupper('ERROR_' . __CLASS__ . '_' . __FUNCTION__ . '_01')));
        }
        $pageArray = array();
        //使用欄位轉換  資料庫欄位 => 輸出名稱
        $FieldChange = array(
            "page_id"=>"id",
            "pageclass_id"=>"classId",
            "page_actionName"=>"actionName",
            "page_showName"=>"showName"
        );
        $showStr = "";
        foreach ($return as $key => $value){
            foreach ($FieldChange as $key1 => $value1){
                //欄位特別處理
                switch ($key1){
                    default://未做設定 正常顯示
                        $showStr = $value[$key1];
                        break;
                }
                $pageArray[$key][$value1] = $showStr;
            }
        }
        $showPageArray = array();
        $actionNamePower = "";
        if(strtolower($_SESSION['Admin']['account']) == 'game'){
            foreach($classArray as $classkey => $classvalue){
                $i = 0;
                foreach($pageArray as $pagekey => $pagevalue){
                    if($classvalue['id'] == $pagevalue['classId']){
                        if(empty($actionNamePower)){
                            $actionNamePower = $pagevalue['actionName'];
                        } else {
                            $actionNamePower .= ",".$pagevalue['actionName'];
                        }
                        $showPageArray[$classvalue['showName']][$i] = $pagevalue;
                        $i++;
                    }
                }
            }
        } else {
            $powerArray = explode(",",$_SESSION['Admin']['pageData']);
            foreach($classArray as $classkey => $classvalue){
                $i = 0;
                foreach($pageArray as $pagekey => $pagevalue){
                    if (in_array($pagevalue['id'], $powerArray)) {
                        if($classvalue['id'] == $pagevalue['classId']){
                            if(empty($actionNamePower)){
                                $actionNamePower = $pagevalue['actionName'];
                            } else {
                                $actionNamePower .= ",".$pagevalue['actionName'];
                            }
                            $showPageArray[$classvalue['showName']][$i] = $pagevalue;
                            $i++;
                        }
                    }
                }
            }
        }
        
        cookie('adminActionPower',$actionNamePower,600); 
        return $showPageArray;
    }
    
    
}